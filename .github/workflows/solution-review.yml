name: Power Platform Solution Review

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'solutions/**/*.zip'
      - '.github/workflows/sample-solution-review.yml'
  push:
    branches: [ main ]
    paths:
      - 'solutions/**/*.zip'
  workflow_dispatch:
    inputs:
      solution_path:
        description: 'Path to solution file (relative to repo root)'
        required: false
        default: 'solutions/MySolution.zip'

jobs:
  review-solution:
    name: Review Power Platform Solution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install powerplatform-review-tool
        run: npm install -g powerplatform-review-tool@latest

      - name: Display tool version
        run: pp-review --version || echo "Version command not available"

      - name: Create output directory
        run: mkdir -p review-output

      - name: Extract Solution Details
        id: extract
        run: |
          SOLUTION_PATH="${{ github.event.inputs.solution_path || 'solutions/MySolution.zip' }}"
          echo "Extracting solution: $SOLUTION_PATH"
          pp-review extract \
            -f "$SOLUTION_PATH" \
            -o review-output/solution-details.json
          echo "extraction_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Review Solution
        id: review
        run: |
          SOLUTION_PATH="${{ github.event.inputs.solution_path || 'solutions/MySolution.zip' }}"
          echo "Reviewing solution: $SOLUTION_PATH"
          pp-review review \
            -f "$SOLUTION_PATH" \
            -o review-output/review-results.json
          echo "review_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse Review Results
        if: steps.review.outputs.review_completed == 'true'
        id: parse
        run: |
          # Extract solution score from SARIF results
          SCORE=$(jq -r '.properties.solutionScore // "N/A"' review-output/review-results.json)
          echo "Solution Score: $SCORE"
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          
          # Count issues by severity
          ERRORS=$(jq '[.runs[].results[] | select(.level == "error")] | length' review-output/review-results.json)
          WARNINGS=$(jq '[.runs[].results[] | select(.level == "warning")] | length' review-output/review-results.json)
          NOTES=$(jq '[.runs[].results[] | select(.level == "note")] | length' review-output/review-results.json)
          
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"
          echo "Notes: $NOTES"
          
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: Upload Review Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: solution-review-results
          path: review-output/
          retention-days: 30

      - name: Upload SARIF Results to GitHub Security
        if: steps.review.outputs.review_completed == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: review-output/review-results.json
          category: power-platform-solution-review
        continue-on-error: true

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.parse.outputs.score != ''
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.parse.outputs.score }}';
            const errors = '${{ steps.parse.outputs.errors }}';
            const warnings = '${{ steps.parse.outputs.warnings }}';
            const notes = '${{ steps.parse.outputs.notes }}';
            
            const comment = `## ðŸ” Power Platform Solution Review Results
            
            **Solution Score:** ${score}
            
            ### Issue Summary
            - âŒ **Errors:** ${errors}
            - âš ï¸ **Warnings:** ${warnings}
            - ðŸ’¡ **Notes:** ${notes}
            
            ### Details
            Review results have been uploaded as artifacts. Check the **Security** tab for detailed SARIF analysis.
            
            ---
            *Generated by [powerplatform-review-tool](https://www.npmjs.com/package/powerplatform-review-tool)*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check Quality Gate
        if: steps.review.outputs.review_completed == 'true'
        run: |
          SCORE="${{ steps.parse.outputs.score }}"
          ERRORS="${{ steps.parse.outputs.errors }}"
          
          # Remove % sign and convert to integer
          SCORE_NUM=$(echo $SCORE | tr -d '%')
          
          echo "Checking quality gate..."
          echo "Score: $SCORE_NUM%"
          echo "Errors: $ERRORS"
          
          # Fail if score is below 70% or there are critical errors
          if [ "$SCORE_NUM" -lt 70 ]; then
            echo "âŒ Quality gate failed: Solution score ($SCORE_NUM%) is below 70%"
            exit 1
          fi
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "âš ï¸ Warning: Found $ERRORS error(s) in the solution"
            # Uncomment to fail on errors:
            # exit 1
          fi
          
          echo "âœ… Quality gate passed!"

      - name: Create Summary
        if: always()
        run: |
          echo "# Power Platform Solution Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.parse.outputs.score }}" != "" ]; then
            echo "**Solution Score:** ${{ steps.parse.outputs.score }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Errors | ${{ steps.parse.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Warnings | ${{ steps.parse.outputs.warnings }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ’¡ Notes | ${{ steps.parse.outputs.notes }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review results have been uploaded as artifacts and to GitHub Security." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Review could not be completed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
